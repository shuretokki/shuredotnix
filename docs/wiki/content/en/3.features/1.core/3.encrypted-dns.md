---
title: Encrypted DNS
description: System-wide encrypted DNS with dnscrypt-proxy2.
navigation:
  icon: i-lucide-shield
---

# Encrypted DNS

This guide explains how to enable system-wide encrypted DNS using dnscrypt-proxy2.

## What You Get

- **Privacy**: Your ISP cannot see which websites you visit
- **Security**: DNSSEC validation prevents DNS spoofing attacks
- **No logging**: Resolvers are required to not log your queries
- **Ad Blocking**: Automatically blocks ads and trackers using OISD Small list

## Quick Start

Encrypted DNS is enabled by default in this configuration. No action required.

## How It Works

```
Your App → localhost:53 → dnscrypt-proxy → Encrypted → Quad9/Cloudflare/Mullvad
```

All DNS queries go through the local dnscrypt-proxy service, which encrypts them using DNS-over-HTTPS before sending to privacy-focused resolvers.

## Verification

Check if DNS is working:

```bash
# Check service status
systemctl status dnscrypt-proxy

# Test DNS resolution
dig google.com @127.0.0.1

# See which resolver handled your query
sudo dnscrypt-proxy -resolve google.com
```

## Configuration

The DNS configuration lives in `library/core/security/dns.nix`.

### Resolvers

By default, we use:
- **Quad9** (primary) — Privacy-focused, threat intelligence
- **Cloudflare** (secondary) — Fast, reliable
- **Mullvad** (redundancy) — Privacy-focused

### Blocklist (Ads & Trackers)

We use the [OISD Small](https://oisd.nl/) blocklist (~400k domains) to block ads and trackers without breaking legitimate sites.
The list is updated daily via a systemd timer.

Force an update manually:

```bash
sudo systemctl start dnscrypt-blocklist
```

## Captive Portals (Wi-Fi Login)

When connecting to public Wi-Fi (hotels, airports), you may need to disable encrypted DNS to access the login page.

Use the `captive-portal` command:

```bash
# Enable captive portal mode (disable encryption)
sudo captive-portal on

# Restore encrypted DNS (after logging in)
sudo captive-portal off

# Check status
sudo captive-portal status
```

The script automatically detects the DHCP DNS servers provided by the network to ensure the login page loads correctly.

## Troubleshooting

### DNS not working after boot

Wait 10-30 seconds for dnscrypt-proxy to download the resolver list on first boot.

### IPv6 issues

IPv6 DNS is disabled by default for stability. To enable:

```nix
ipv6_servers = true;
block_ipv6 = false;
```

## Learn More

- [How DNS Works](https://howdns.works/) — Visual comic
- [DNSCrypt Docs](https://dnscrypt.info/) — Official documentation
- [NixOS Wiki](https://wiki.nixos.org/wiki/Encrypted_DNS) — NixOS-specific setup
