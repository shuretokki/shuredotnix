---
tags: [meta, documentation, analysis]
---

# DK-002: Context System Flow Analysis

**Related Code:** `docs/.sym_context/`, `.agent/rules/project-rules.md`
**Last Updated:** 2026-01-04

## Definition
This document analyzes the interaction between the `.sym_context` documentation system and the NixOS configuration, identifying edge cases, weaknesses, and mitigation strategies.

---

## The Context Interaction Flow

### 1. Phase 0: The Planning Stage

**Trigger:** A new user request (e.g., "Install Hyprland", "Fix Bluetooth").

**Technical Process:**
1.  **Context Loading**: Before ANY code is written, the agent reads `docs/docs/.sym_context/domain_knowledge/*` to understand existing architectural patterns.
...
- `docs/.sym_context/README.md` -> `docs/docs/.sym_context/README.md`
- Index files (`000.md`) in `docs/docs/.sym_context/...`
2.  **Impact Analysis**: The agent checks if the request triggers any documented systems (e.g., does it modify variables in `vars.nix`? does it affect the build system?).
3.  **Documentation flagging**: The agent identifies which specific DK or ADR files will likely need updates based on the proposed changes.

**Outcome:** A plan is formed that includes not just code changes, but specific requirements for updating documentation.

### 2. The Execution Stage (Atomic Loop)

**Trigger:** The user approves the Implementation Plan.

**Technical Process:**
1.  **Code Modification**: The agent edits a single Nix file.
2.  **State Capture**: The agent immediately runs `git add <file>` and `git commit` to serialize the state.
3.  **Drift Tracking**: During this loop, the agent maintains an internal checklist of "Systems Modified" vs "Docs Updated".

**Outcome:** A series of atomic commits for the code, while the documentation "debt" accrues on the checklist.

### 3. Phase 5: The Synchronization Stage

**Trigger:** User has successfully built/tested the changes (e.g., "It works", "Build passed").

**Technical Process:**
1.  **Debt Reconciliation**: The agent reviews the checklist generated in Phase 0/Execution.
    -   If `vars.nix` changed -> `DK001.md` is opened and updated.
    -   If a new module was added -> The decision is weighed: "Does this need a new DK file?"
    -   If an error was solved -> `troubleshooting/` is populated.
2.  **Conflict Resolution**: If the code explicitly contradicts an existing document, the document is rewritten to reflect the new reality (The "No Stale Docs" rule).
3.  **Commit**: All documentation changes are batched into a single `update context docs` commit to separate "meta" work from "product" work.

**Outcome:** The `.sym_context` repository is synchronized with the actual state of the codebase, ready for the next session.

---

## Edge Cases & Weaknesses

### 1. Stale Documentation (HIGH RISK)

**Scenario:** Code is modified but `docs/.sym_context/` isn't updated.

**Why it happens:**
- Human forgets to update docs
- AI session ends before docs are updated
- Change seems "minor" but has ripple effects

**Mitigation:**
- Maintenance Protocol in rules (checklist before task completion)
- **Weakness:** No automated validation; relies on discipline
- **Future improvement:** A `nix run .#validate-context` script that checks if documented files exist

### 2. Context Overload (MEDIUM RISK)

**Scenario:** Too many DK/ADR files make it hard to find relevant info.

**Why it happens:**
- Over-documentation of trivial decisions
- Files not organized by topic

**Mitigation:**
- Complexity threshold rule (don't over-document)
- Index files (000.md) in each folder
- **Weakness:** No tagging/search system
- **Future improvement:** Add `tags:` frontmatter to each file

### 3. Context Not Read (MEDIUM RISK)

**Scenario:** Contributor (human or AI) makes changes without reading existing context.

**Why it happens:**
- New session with no memory
- Large codebase, context files overlooked

**Mitigation:**
- PHASE 0 in rules mandates reading context first
- Related Code links in DK files point to affected code
- **Weakness:** Reader must know WHICH context file to read
- **Future improvement:** A `README.md` in `docs/.sym_context/` with a decision tree

### 4. Multi-Machine Sync Issues (LOW RISK)

**Scenario:** Context is machine-specific and breaks on other devices.

**Why it happens:**
- Hardcoded paths in documentation
- Machine-specific troubleshooting steps

**Mitigation:**
- `vars.nix` abstraction already handles user/host differences
- Docs reference `vars.username` not literal usernames
- **Future improvement:** None needed currently

### 5. Orphaned Context Files (MEDIUM RISK)

**Scenario:** Code is deleted but its DK/ADR file remains.

**Why it happens:**
- Module removed during refactor
- No backlink from code -> context

**Mitigation:**
- DK files have `Related Files:` section
- **Weakness:** No automated orphan detection
- **Future improvement:** Script to check if `Related Files:` paths exist

### 6. Session Boundary Problem (HIGH RISK)

**Scenario:** AI session ends mid-task; context update is forgotten.

**Why it happens:**
- User closes chat before confirmation
- Long task spans multiple sessions

**Mitigation:**
- Checklist at end of task in rules
- **Weakness:** If session ends abruptly, no reminder
- **Future improvement:** User habit: "Always end session with context check"

### 7. Conflicting ADRs (LOW RISK)

**Scenario:** Two ADRs give contradictory guidance.

**Why it happens:**
- Newer decision didn't deprecate old one
- Different authors, no cross-referencing

**Mitigation:**
- ADR `Status:` field (Proposed | Accepted | Deprecated)
- Single maintainer currently (you)
- **Future improvement:** ADRs should link to superseded ADRs

---

## Risk Summary Matrix

| Risk | Probability | Impact | Mitigation Quality |
|------|-------------|--------|---------------------|
| Stale Documentation | High | High | Partial (relies on discipline) |
| Context Overload | Medium | Medium | Good (threshold rules) |
| Context Not Read | Medium | High | Partial (no discovery system) |
| Multi-Machine Issues | Low | Medium | Excellent (vars.nix) |
| Orphaned Files | Medium | Low | Partial (manual tracking) |
| Session Boundary | High | Medium | Partial (checklist only) |
| Conflicting ADRs | Low | Medium | Good (status field) |

---

## Recommended Improvements (Priority Order)

### Immediate (Add to workflow)
1. **End-of-session habit:** "Did I update context?" becomes a verbal/mental checkpoint

### Short-term (Create files)
2. **`docs/.sym_context/README.md`** — Decision tree for "which file do I read?"
3. **Index update protocol** — When adding DK/ADR, also update the 000.md index

### Long-term (Scripts/automation)
4. **`validate-context.sh`** — Check for orphaned files, missing indexes
5. **Tags/search** — Add `tags:` to frontmatter of filtering

---

## Related Files
- `.agent/rules/project-rules.md` — PHASE 5 defines context rules
- `docs/.sym_context/*/000.md` — Index files
- `vars.nix` — Central config that DK_001 documents
