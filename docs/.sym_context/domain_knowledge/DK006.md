---
tags: [gpu, nvidia, amd, hardware]
---

# DK-006: GPU Module System

**Related Code:** `library/core/gpu/`
**Last Updated:** 2026-01-05

## Overview
Modular GPU support for NVIDIA and AMD graphics cards, designed for forkability across hardware generations.

## Module Structure

```
library/core/gpu/
├── default.nix    # Aggregator with mutual exclusion assertion
├── nvidia.nix     # NVIDIA support (RTX 5xxx → GTX 7xx)
└── amd.nix        # AMD support (RX 7xxx → HD 7000)
```

## NVIDIA Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `enable` | bool | false | Enable NVIDIA support |
| `open` | bool | **true** | Use open kernel modules (REQUIRED for RTX 5xxx) |
| `legacy` | null/"470"/"390" | null | Legacy driver branch for older GPUs |
| `prime.enable` | bool | false | Optimus/hybrid graphics |
| `prime.mode` | "sync"/"offload" | "offload" | Prime mode |
| `prime.nvidiaBusId` | string | "" | NVIDIA GPU PCI bus ID |
| `prime.intelBusId` | string | "" | Intel iGPU PCI bus ID |
| `prime.amdBusId` | string | "" | AMD iGPU PCI bus ID |

### Generation Compatibility

| Generation | Architecture | `open` | `legacy` |
|------------|--------------|--------|----------|
| RTX 5xxx | Blackwell | **true** (required) | null |
| RTX 4xxx | Ada Lovelace | true | null |
| RTX 3xxx | Ampere | true | null |
| RTX 2xxx | Turing | true | null |
| GTX 10xx | Pascal | false | null |
| GTX 9xx | Maxwell | false | "470" |
| GTX 7xx | Kepler | false | "390" |

## AMD Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `enable` | bool | false | Enable AMD support |

AMD automatically uses:
- `hardware.amdgpu.initrd.enable = true` (early KMS)
- `hardware.amdgpu.legacySupport.enable = false` (set true for HD 7000/8000)
- ROCm OpenCL support

### Generation Compatibility

| Generation | Driver | Notes |
|------------|--------|-------|
| RX 7xxx | amdgpu | RDNA3, default |
| RX 6xxx | amdgpu | RDNA2 |
| RX 5xxx | amdgpu | RDNA1 |
| RX Vega | amdgpu | GCN5 |
| RX 400/500 | amdgpu | GCN4 |
| R9/R7 | amdgpu | May need legacySupport |
| HD 7000/8000 | amdgpu | legacySupport = true |

## Usage Examples

```nix
# Modern NVIDIA (RTX 20xx+)
library.core.gpu.nvidia.enable = true;

# Legacy NVIDIA (GTX 10xx)
library.core.gpu.nvidia.enable = true;
library.core.gpu.nvidia.open = false;

# Very old NVIDIA (GTX 9xx)
library.core.gpu.nvidia.enable = true;
library.core.gpu.nvidia.open = false;
library.core.gpu.nvidia.legacy = "470";

# Laptop with Intel + NVIDIA
library.core.gpu.nvidia.enable = true;
library.core.gpu.nvidia.prime.enable = true;
library.core.gpu.nvidia.prime.nvidiaBusId = "PCI:1:0:0";
library.core.gpu.nvidia.prime.intelBusId = "PCI:0:2:0";

# AMD (any modern card)
library.core.gpu.amd.enable = true;

# AMD legacy (HD 7000/8000)
library.core.gpu.amd.enable = true;
# Then manually set: hardware.amdgpu.legacySupport.enable = true;
```

## Edge Cases

- **RTX 5xxx with `open = false`**: Will fail. Blackwell requires open drivers.
- **GTX 10xx with `open = true`**: May fail. Pascal needs proprietary drivers.
- **AMD + NVIDIA without prime**: Blocked by assertion. Use prime for valid configs.

## Related Files
- `library/core/gpu/nvidia.nix`
- `library/core/gpu/amd.nix`
- `hosts/*/default.nix` (where GPU is enabled)
